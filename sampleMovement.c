#pragma config(Sensor, S1,     touchSensor,    sensorEV3_Touch)
#pragma config(Sensor, S2,     gyroSensor,     sensorEV3_Gyro, modeEV3Gyro_RateAndAngle)
#pragma config(Sensor, S3,     colorSensor,    sensorEV3_Color, modeEV3Color_Color)
#pragma config(Sensor, S4,     sonarSensor,    sensorEV3_Ultrasonic)
#pragma config(Motor,  motorA,          rightMotor,    tmotorEV3_Large, PIDControl, driveRight, encoder)
#pragma config(Motor,  motorD,          leftMotor,     tmotorEV3_Large, PIDControl, driveLeft, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

int distanceLeft=0,distanceRight=0;
int meanDistance=0;
int basePower = 50;
float KP = 1.5;
float K_angle = 2.488 * 1.1;
int defaultGyroRate = 0;
float KpGyro = 0.5;
float KiGyro = 0;
float KdGyro = 0.5;
void moveForward(int t){
	t *= 10*1.25;
	for(int i=0;i<t;i++){
		distanceLeft = getMotorEncoder(leftMotor);
		distanceRight = getMotorEncoder(rightMotor);
		meanDistance = (distanceLeft + distanceRight) / 2;
		motor[leftMotor] = basePower + (meanDistance - distanceLeft)*KP;
		motor[rightMotor] = basePower + (meanDistance - distanceRight)*KP;
		resetMotorEncoder(leftMotor);
		resetMotorEncoder(rightMotor);
		wait1Msec(100);
	}
}
int lastGyroErr=0;
int gyroErr = 0;
int sumGyroErr =0;
void moveForwardWithGyro(){
		int gyroRate = getGyroRate(gyroSensor);
		gyroErr = defaultGyroRate - gyroRate;
		sumGyroErr += gyroErr;
		motor[leftMotor] = basePower+3 + gyroErr*KpGyro + KiGyro*sumGyroErr - KdGyro*(lastGyroErr - gyroErr) ;
		motor[rightMotor] = basePower - gyroErr*KpGyro - KiGyro*sumGyroErr + KdGyro*(lastGyroErr - gyroErr);

		lastGyroErr = gyroErr;
		wait1Msec(25);
}
void turn(int angle){
	setMotorTarget(leftMotor,-angle*K_angle,basePower/2);
	setMotorTarget(rightMotor,angle*K_angle,basePower/2);
	//waitUntilMotorStop(leftMotor);
	//waitUntilMotorStop(rightMotor);
	wait1Msec(4*1000);
	resetMotorEncoder(leftMotor);
	resetMotorEncoder(rightMotor);
}

task main()
{

	resetMotorEncoder(leftMotor);
	resetMotorEncoder(rightMotor);

	defaultGyroRate = getGyroRate(gyroSensor);

	for(int i=0;i<1000;i++){
		moveForwardWithGyro();
	}




}
